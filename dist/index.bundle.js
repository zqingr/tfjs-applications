exports.tools=function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=2)}([function(t,e){t.exports=require("@tensorflow/tfjs")},function(t,e){t.exports=require("canvas")},function(t,e,s){"use strict";s.r(e);var i=s(0);function a({inputs:t,filters:e=16,kernelSize:s=3,strides:a=1,activation:n="relu",batchNormalization:r=!0,convFirst:o=!0}){const l=i.layers.conv2d({filters:e,kernelSize:s,strides:a,padding:"same",kernelInitializer:i.initializers.heNormal({}),kernelRegularizer:i.regularizers.l2({l2:1e-4})});let c=t;return o?(c=l.apply(c),r&&(c=i.layers.batchNormalization({axis:3}).apply(c)),n&&(c=i.layers.activation({activation:n}).apply(c))):(r&&(c=i.layers.batchNormalization({axis:3}).apply(c)),n&&(c=i.layers.activation({activation:n}).apply(c)),c=l.apply(c)),c}var n=s(1),r=s(4),o=s.n(r);class l{constructor(){this.DATA_PRE_NUM=1e4,this.trainM=0,this.testM=0,this.shuffledTrainIndex=0,this.shuffledTestIndex=0,this.currentTrainIndex=0}get IMAGE_SIZE(){return this.IMG_WIDTH*this.IMG_HEIGHT*3}loadImg(t){return new Promise((e,s)=>{new n.Image;const i=Object(n.createCanvas)(),a=i.getContext("2d");o.a.readFile(process.cwd()+"/src"+t,(t,r)=>{if(t)throw t;const o=new n.Image;o.onload=(()=>{i.width=o.naturalWidth,i.height=o.naturalHeight;const t=new ArrayBuffer(i.width*i.height*3*4),s=new Float32Array(t);a.drawImage(o,0,0,i.width,i.height,0,0,i.width,i.height);const n=a.getImageData(0,0,i.width,i.height);for(let t=0,e=0;t<n.data.length;t++)(t+1)%4!=0&&(s[e++]=n.data[t]/255);e(s)}),o.onerror=s,o.src=r})})}loadImages(t){return Promise.all(t.map(this.loadImg))}async load(){this.trainDatas=await this.loadImages(this.TRAIN_IMAGES),this.testDatas=await this.loadImages(this.TEST_IMAGES),this.trainLables=await JSON.parse(o.a.readFileSync(process.cwd()+"/src"+this.TRAIN_LABLES,"utf8")),this.testLables=await JSON.parse(o.a.readFileSync(process.cwd()+"/src"+this.TEST_LABLES,"utf8")),this.trainM=this.trainLables.length,this.testM=this.testLables.length,this.trainIndices=i.util.createShuffledIndices(this.trainM),this.testIndices=i.util.createShuffledIndices(this.testM)}nextBatch(t,[e,s],a){const n=new Float32Array(t*this.IMAGE_SIZE),r=(new Uint8Array(t*this.NUM_CLASSES),[]);for(let i=0;i<t;i++){const t=a(),o=t%this.DATA_PRE_NUM,l=e[Math.floor(t/this.DATA_PRE_NUM)].slice(o*this.IMAGE_SIZE,o*this.IMAGE_SIZE+this.IMAGE_SIZE);n.set(l,i*this.IMAGE_SIZE),r.push(s[t])}return{xs:i.tensor2d(n,[t,this.IMAGE_SIZE]),ys:i.oneHot(r,this.NUM_CLASSES)}}nextTrainBatch(t=this.trainM){return this.shuffledTrainIndex=(this.shuffledTrainIndex+1)%this.trainIndices.length,this.nextBatch(t,[this.trainDatas,this.trainLables],()=>(this.shuffledTrainIndex=(this.shuffledTrainIndex+1)%this.trainIndices.length,this.trainIndices[this.shuffledTrainIndex]))}nextTestBatch(t=this.testM){return this.shuffledTestIndex=(this.shuffledTestIndex+1)%this.testIndices.length,this.nextBatch(t,[this.testDatas,this.testLables],()=>(this.shuffledTestIndex=(this.shuffledTestIndex+1)%this.testIndices.length,this.testIndices[this.shuffledTestIndex]))}}class c extends l{constructor(){super(...arguments),this.TRAIN_IMAGES=["/datasets/cifar10/data_batch_1.png","/datasets/cifar10/data_batch_2.png","/datasets/cifar10/data_batch_3.png","/datasets/cifar10/data_batch_4.png","/datasets/cifar10/data_batch_5.png"],this.TRAIN_LABLES="/datasets/cifar10/train_lables.json",this.TEST_IMAGES=["/datasets/cifar10/test_batch.png"],this.TEST_LABLES="/datasets/cifar10/test_lables.json",this.IMG_WIDTH=32,this.IMG_HEIGHT=32,this.NUM_CLASSES=10}}s(3);const h=function({inputShape:t,depth:e,numClasses:s=10}){if((e-2)%9!=0)throw new Error("depth should be 9n+2 (eg 56 or 110 in [b])");let n=16,r=0;const o=(e-2)/9,l=i.input({shape:t});let c=a({inputs:l});for(let t=0;t<3;t++){for(let e=0;e<o;e++){let s=!0,o=1,l="relu";0===t?(r=4*n,0===e&&(l="",s=!1)):(r=2*n,0===e&&(o=2));let h=a({inputs:c,filters:n,kernelSize:1,strides:o,activation:l,batchNormalization:s,convFirst:!1});h=a({inputs:h=a({inputs:h,filters:n,convFirst:!1}),filters:r,kernelSize:1,convFirst:!1}),0===e&&(c=a({inputs:c,filters:r,kernelSize:1,strides:o,activation:"",batchNormalization:!1})),c=i.layers.add().apply([c,h])}n=r}c=i.layers.batchNormalization({}).apply(c),c=i.layers.activation({activation:"relu"}).apply(c),c=i.layers.averagePooling2d({poolSize:8}).apply(c);let h=i.layers.flatten({}).apply(c);return h=i.layers.dense({units:s,activation:"softmax",kernelInitializer:i.initializers.heNormal({})}).apply(h),i.model({inputs:l,outputs:h,name:"ResNetV2_"+e})}({inputShape:[32,32,3],depth:11}),d=i.train.adam();h.compile({optimizer:d,loss:"categoricalCrossentropy",metrics:["accuracy"]}),async function(){const t=new c;await t.load(),await async function(t){console.log(1);const{xs:e,ys:s}=t.nextTrainBatch();console.log(2),await h.fit(e.reshape([5e4,32,32,3]),s,{batchSize:32,epochs:200,callbacks:{onBatchEnd:(t,e)=>(console.log(t,e),i.nextFrame()),onEpochBegin:(t,e)=>(console.time("Epoch training time"),console.groupCollapsed("epoch times:",t),i.nextFrame()),onEpochEnd:(e,s)=>{console.groupEnd(),console.timeEnd("Epoch training time"),console.log(e,s);const a=t.nextTestBatch(2e3),n=h.evaluate(a.xs.reshape([2e3,32,32,3]),a.ys);return console.timeEnd("Totol training time"),n[0].print(),n[1].print(),i.nextFrame()}}}),await i.nextFrame()}(t)}()},function(t,e){t.exports=require("@tensorflow/tfjs-node")},function(t,e){t.exports=require("fs")}]);